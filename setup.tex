% Character set
\usepackage{cmap}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc} % ensure that all the characters in characterSets.tex prints
\usepackage{upquote} % \textcent

% A background text to prevent wide distribution
\usepackage{draftwatermark}
\SetWatermarkText{DRAFT}
\SetWatermarkScale{6}
\SetWatermarkLightness{.95}

% Page setup
\usepackage[margin=25mm,outer=35mm,marginparsep=5mm]{geometry}

% Extra math stuff
\usepackage{amsmath,amssymb}

% Figures
\usepackage{graphicx}
\graphicspath{{figures/}}

% clickable url
\usepackage{url}

% figures
\usepackage{subfigure}

% paragraphs in tables
\usepackage{tabularx}

% formatting lists
\usepackage{enumitem}
%\setlist[description]{leftmargin=0pt,labelindent=0pt,itemindent=0pt}
%\setlist[description]{itemindent=-\leftmargin}

% latex comment environment
\usepackage{comment}

% Margin notes
%\usepackage{marginnote}

% Clickable table of content
\usepackage[pdfpagelabels]{hyperref}

% List of indices
\usepackage{makeidx}
\newcommand{\idxs}[1]{\marginpar{$\cdot$~\parbox[t]{25mm}{\raggedright #1}}\index{#1}}
\newcommand{\idxss}[1]{\index{#1}}
% Define a new command idx with an optional parameter, which if given is the key to the index
\makeatletter
\def\idx{\@ifnextchar[{\@with}{\@without}}
\def\@with[#1]#2{\emph{#2}\idxs{#1}}
\def\@without#1{\emph{#1}\idxs{#1}}
\makeatother
%\newcommand{\idx}[1]{\emph{#1}\idxs{#1}}
\newcommand{\keyword}[1]{``\lstinline[language=fsharp]|#1|''}
\newcommand{\lexeme}[1]{``\lstinline[language=fsharp]|#1|''}
\makeindex

\usepackage[table]{xcolor}
\definecolor{alternateKeywordsColor}{rgb}{0.13,1,0.13}
\definecolor{keywordsColor}{rgb}{0.13,0.13,1}
%\definecolor{commentsColor}{rgb}{0,0.5,0}
\definecolor{commentsColor}{rgb}{0,0.5,0}
%\definecolor{stringsColor}{rgb}{0.9,0,0}
\definecolor{stringsColor}{rgb}{0,0,0.5}
\definecolor{light-gray}{gray}{0.95}

\definecolor{headerRowColor}{rgb}{0.85,0.85,0.85}
\definecolor{oddRowColor}{rgb}{0.95,0.95,0.95}
\definecolor{evenRowColor}{rgb}{1,1,1}

% We want to emphasize problem formulation
\usepackage{tcolorbox}
\tcbset{%
  colframe=green!45!black,
  fonttitle=\bfseries, 
  leftrule=3mm,
  sharp corners=downhill,
  colback=black!5!white,
  left=1mm,
  top=1mm,
  right=1mm,
  bottom=1mm,
  middle=1mm,
  arc=2mm,
}
\tcbuselibrary{listings}
%\newenvironment{problem}{\begin{quote}}{\end{quote}}
%\newmdenv[linecolor=black,linewidth=1.5pt,roundcorner=10pt,frametitle={Problem:}]{problem}
% \newtcblisting{problem}{%
%   colback=red!15,
%   colframe=red!75!black,
%   arc=5pt,
%   listing only,
%   title={Problem:}
% }
\newtcolorbox[auto counter, number within=chapter]{problem}[1][]{%
  title=Problem~\thetcbcounter:,
  colframe=green!30!blue,
  #1}

%% lstlisting stuff
\usepackage{listings}
\usepackage{moreverb} % To use verbatimwrite to write listing to file.
%\usepackage{chngcntr}
%\usepackage[framemethod=tikz]{mdframed}
%\surroundwithmdframed[linecolor=red,linewidth=1.5pt,roundcorner=10pt]{listings}
% \surroundwithmdframed[
% skipabove=10pt,
% innertopmargin=0pt,
% % rightmargin=0pt,
% % innerrightmargin=0pt,
% skipbelow=0pt,
% innerbottommargin=0pt
% % leftmargin=0pt,
% % innerleftmargin=0pt,
% ]{lstlisting}
% \mdfsetup{% 
%   backgroundcolor=lightgray!10,
%   roundcorner=5pt}

\lstdefinelanguage{fsharp}{%
   keywords={abstract, and, as, assert, base, begin, class, default, delegate, do, done, downcast, downto, elif, else, end, exception, extern, false, finally, for, fun, function, global, if, in, inherit, inline, interface, internal, lazy, let, match, member, module, mutable, namespace, new, null, of, open, or, override, private, public, rec, return, sig, static, struct, then, to, true, try, type, upcast, use, val, void, when, while, with, yield},
   morekeywords={atomic, break, checked, component, const, constraint, constructor, continue, eager, fixed, fori, functor, include, measure, method, mixin, object, parallel, params, process, protected, pure, recursive, sealed, tailcall, trait, virtual, volatile},
   otherkeywords={ let!, return!, do!, yield!, use!},
   keywordstyle=\color{keywordsColor},
   %sensitive=true,
   basicstyle=\ttfamily\lst@ifdisplaystyle\small\fi, % make font small for listings but not for lstinline
   breaklines=true,
   showstringspaces=false,
   morecomment=[l][\color{commentsColor}]{///},
   morecomment=[l][\color{commentsColor}]{//},
   morecomment=[s][\color{commentsColor}]{{(*}{*)}},
   morestring=[b]",
   literate={`}{\`}1,
   stringstyle=\color{stringsColor},
   showspaces=true,
   numbers=left,
   numbersep=6pt,
   numberstyle=\scriptsize\color{white},
   %aboveskip=0pt, 
   %belowskip=0pt,
   %resetmargins=true,
   % captionpos=b,
   % backgroundcolor=\color{black!5!white},
}
\lstdefinelanguage{ebnf}{%
  keywords={},
  morekeywords={},
  otherkeywords={},
  keywordstyle=\color{keywordsColor},
  % sensitive=true,
  basicstyle=\fontfamily{pcr}\selectfont\lst@ifdisplaystyle\small\fi, 
  breaklines=true,
  morecomment=[s][\color{commentsColor}]{{(*}{*)}},
  morestring=[b]",
  morestring=[b]',
  alsoletter={\\},
  showstringspaces=false,
  % stringstyle=\color{stringsColor},
  % aboveskip=0pt, 
  % belowskip=0pt,
  % resetmargins=true,
  % captionpos=b,
  % backgroundcolor=\color{blue!10!white},
}
\lstdefinelanguage{console}{%
  keywords={},
  morekeywords={},
  otherkeywords={},
  basicstyle=\ttfamily\lst@ifdisplaystyle\small\fi, 
  breaklines=true,
  showstringspaces=false,
  % aboveskip=0pt, 
  % belowskip=0pt,
  % resetmargins=true,
  % captionpos=b,
  % backgroundcolor=\color{green!10!white},
}
%\lstset{language=fsharp, frame=single}
\lstset{language=fsharp}
\makeatletter
\def\lst@visiblespace{ }
\makeatother

\newcommand{\filename}[1]{\lstinline[language=console]{#1}}

%\usepackage{caption}
%\DeclareCaptionStyle{listing} [justification=raggedright,labelfont=bf]{}
%\captionsetup[lstlisting]{style=listing}

\usepackage{verbdef}
\verbdef{\cmdl}{>}

\newcommand{\src}{src}
\newtcolorbox[auto counter, number within=chapter]{codeNOutput}[2][]{%
  title={Listing~\thetcbcounter#2},
  %float,
  % colback=blue!5!white,
  #1}

\makeatletter
\def\fs{%
  % input .fsx and .out listings from \src and display as code and result in same figure
  % #1 = optional further arguments for lstinputlisting
  % #2 = filename without suffix, and label
  % #3 = caption
\@ifnextchar[{\@fswith}{\@fswithout}}
\def\@fswith[#1]#2#3{%
  \begin{codeNOutput}[label=#2]{, #2.fsx:\\#3}
    \lstinputlisting[language=fsharp,#1]{\src/#2.fsx}
    \tcblower %\tcbsubtitle[before skip=\baselineskip]{Output:}
    \lstinputlisting[language=console]{\src/#2.out}
  \end{codeNOutput}
}
\def\@fswithout#1#2{%
  \begin{codeNOutput}[label=#1]{, #1.fsx:\\#2}
    \lstinputlisting[language=fsharp]{\src/#1.fsx}
    \tcblower %\tcbsubtitle[before skip=\baselineskip]{Output:}
    \lstinputlisting[language=console]{\src/#1.out}
  \end{codeNOutput}
}

\makeatletter
\def\fsSeparated{%
  % input .fsx and .out listings from \src and display as code and result in two separate figures
  % #1 = optional further arguments for lstinputlisting
  % #2 = filename without suffix, and label
  % #3 = caption
\@ifnextchar[{\@fsSeparatedwith}{\@fsSeparatedwithout}}
\def\@fsSeparatedwith[#1]#2#3{%
  \begin{codeNOutput}[label=#2]{, #2.fsx:\\#3}
    \lstinputlisting[language=fsharp,#1]{\src/#2.fsx}
  \end{codeNOutput}
  \begin{codeNOutput}[label=#2Output]{, Output of Listing~\ref{#2}.}
    \lstinputlisting[language=console]{\src/#2.out}
  \end{codeNOutput}
}
\def\@fsSeparatedwithout#1#2{%
  \begin{codeNOutput}[label=#1]{, #1.fsx:\\#2}
    \lstinputlisting[language=fsharp]{\src/#1.fsx}
  \end{codeNOutput}
  \begin{codeNOutput}[label=#1Output]{, Output of Listing~\ref{#1}.}
    \lstinputlisting[language=console]{\src/#1.out}
  \end{codeNOutput}
}
% \newcommand{\fse}[2]{
%   \begin{codeNOutput}[label=#1]{: #2}
%     \lstinputlisting[language=fsharp]{\src/#1.fsx}
%   \end{codeNOutput}
% }

% \makeatletter
% \def\fsCode{%
%   % dispaly input file .fsx from \src
%   % #1 = optional further arguments for lstinputlisting
%   % #2 = filename without suffix, and label
%   % #3 = caption
% \@ifnextchar[{\@fsCodewith}{\@fsCodewithout}}
% \def\@fsCodewith[#1]#2#3{%
% \begin{codeNOutput}[label=#2]{, #2.fsx:\\#3}
%     \lstinputlisting[language=fsharp,#1]{\src/#2.fsx}
% \end{codeNOutput}
% }
% \def\@fsCodewithout#1#2{%
% \begin{codeNOutput}[label=#1]{, #1.fsx:\\#2}
%     \lstinputlisting[language=fsharp]{\src/#1.fsx}
% \end{codeNOutput}
% }
% \makeatother
\newtcbinputlisting[auto counter,number within=chapter]{\fsCode}[4]{%
  listing file={src/#1.fsx},
  listing only,
  listing options={language=fsharp,#4},
  title=\textbf{Listing \thetcbcounter}\textbf{:} {#1.fsx:\\#3},
  label={#2},
}
\makeatletter
\def\fsOutput{%
  % dispaly input file .fsx from \src
  % #1 = optional further arguments for lstinputlisting
  % #2 = filename without suffix, and label
  % #3 = caption
\@ifnextchar[{\@fsOutputwith}{\@fsOutputwithout}}
\def\@fsOutputwith[#1]#2#3{%
\begin{codeNOutput}[label=#2,width=\hsize,box align=center]{: #3}
    \lstinputlisting[language=console,#1]{\src/#2.out}
\end{codeNOutput}
}
\def\@fsOutputwithout#1#2{%
\begin{codeNOutput}[label=#1,width=\hsize,box align=center]{: #2}
    \lstinputlisting[language=console]{\src/#1.out}
\end{codeNOutput}
}
%\def\@with[#1]#2#3{\begin{codeNOutput}[label=#2]{: #3}\lstinputlisting[language=fsharp,#1]{\src/#2.fsx}\end{codeNOutput}}
%\def\@without#1#2{\begin{codeNOutput}[label=#1]{: #2}\lstinputlisting[language=fsharp]{\src/#1.fsx}\end{codeNOutput}}
\makeatother

\makeatletter
\def\ebnf{%
  % dispaly input file .fsx from \src
  % #1 = optional further arguments for lstinputlisting
  % #2 = filename
  % #3 = caption
\@ifnextchar[{\@ebnfwith}{\@ebnfwithout}}
\def\@ebnfwith[#1]#2#3{%
\begin{codeNOutput}[colframe=black!60!white,width=\hsize,box align=center]{: #3}
    \lstinputlisting[language=ebnf,#1]{#2}
\end{codeNOutput}
}
\def\@ebnfwithout#1#2{%
\begin{codeNOutput}[colframe=black!60!white,width=\hsize,box align=center]{: #2}
    \lstinputlisting[language=ebnf]{#1}
\end{codeNOutput}
}
%\def\@with[#1]#2#3{\begin{codeNOutput}[label=#2]{: #3}\lstinputlisting[language=fsharp,#1]{\src/#2.fsx}\end{codeNOutput}}
%\def\@without#1#2{\begin{codeNOutput}[label=#1]{: #2}\lstinputlisting[language=fsharp]{\src/#1.fsx}\end{codeNOutput}}
\makeatother

% Get counters from references for firstnumber references in lstinputlisting
\usepackage{refcount}
\newcounter{lstFrom}
\newcounter{lstTo}
% Example: 
% \setcounterref{lstFrom}{dynamicScopeTracing:a1}
% \setcounterref{lstTo}{dynamicScopeTracing:a2}
% \lstinputlisting[firstline=\thelstFrom,lastline=\thelstTo,escapechar=|]{\src/dynamicScopeTracing.fsx}

% highlighted text snippets
\newcommand{\advice}[1]{\marginpar{Advice}{\textbf{#1}}}
\newcommand{\advanced}[1]{\marginpar{Advanced material}\textbf{#1}}

% paragraph indentation is stupid
\setlength\parindent{0pt}
\setlength{\parskip}{1em}

% Scratch out math
\usepackage{cancel}

% Draw arrows between elements
\usepackage{tikz}
%\usepackage{sphack} % make overlays invisible where stated in text
\usetikzlibrary{arrows,shapes,calc,decorations.pathreplacing}
\newcommand{\tikzmark}[1]{\tikz[overlay,remember picture] \node (#1) {};}
\newcommand*{\DrawArrow}[3][]{%
  % #1 = draw options
  % #2 = left point
  % #3 = right point
  \begin{tikzpicture}[overlay,remember picture]
    %\draw [-latex, #1,ultra thick,red] ($(#2)+(0.1em,0.5ex)$) to ($(#3)+(0,0.5ex)$);
    \draw [-latex, #1,ultra thick,red] ($(#2) -(0,0.5ex)$) to ($(#3)+(0,2ex)$);
  \end{tikzpicture}%
}%
\newcommand*{\AddNote}[4]{%
  \begin{tikzpicture}[overlay, remember picture]
    \draw [decoration={brace,amplitude=0.5em},decorate,ultra thick,red]
    ($(#3)!([yshift=1.5ex]#1)!($(#3)-(0,1)$)$) -- ($(#3)!(#2)!($(#3)-(0,1)$)$)
    node [align=left, text width=0cm, pos=0.5, anchor=west, xshift=.2cm] {#4};
  \end{tikzpicture}
}%
\newcommand{\FrameArea}[2]{%
  % #1 = top left point
  % #2 = bottom right point
  % The overlay is drawn in the margin in order not to screw with
  % horizontal spacing.
  \begin{tikzpicture}[overlay,remember picture]
      \draw[red,rounded corners] ([shift={(-2pt,1.9ex)}] #1)  rectangle  ([shift={(2pt,-.9ex)}] #2);
    \end{tikzpicture}
}%

% Notes to self
\newcommand{\jon}[1]{\footnote{Todo: \textbf{#1}}}
%\renewcommand{\jon}[1]{}
\newcommand{\spec}[1]{\footnote{Spec: \textbf{#1}}}
\renewcommand{\spec}[1]{}

%%% Local Variables:
%%% TeX-master: "fsharpNotes"
%%% End:
